name: Release

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  tag-check:
    name: Check Release Tag
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Check Out Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Find Semver Tag
        id: tag
        run: |
          git fetch --prune --tags -f
          tag=$(git tag --points-at "$GITHUB_SHA" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1)
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

  release:
    name: Release
    needs: tag-check
    if: needs.tag-check.outputs.tag != ''
    runs-on: ubuntu-latest
    environment: release
    timeout-minutes: 45
    steps:
      - name: Check Out Code
        uses: actions/checkout@v6

      - name: Go 1.25
        uses: actions/setup-go@v6
        with:
          go-version: "^1.25"

      - name: Install Minisign
        run: sudo apt-get update --fix-missing && sudo apt-get -y install minisign

      - name: Build Clients
        run: |
          make clients
          mkdir -p artifacts
          mv sliver-client_* artifacts/

      - name: Build Servers
        run: |
          make servers
          mv sliver-server_* artifacts/

      - name: Sign Artifacts
        env:
          MINISIGN_KEY: ${{ secrets.MINISIGN_SLIVER_RELEASE_KEY }}
        run: |
          key_payload=$(printf '%b' "$MINISIGN_KEY")
          if printf '%s' "$key_payload" | grep -qi "minisign secret key"; then
            printf '%s\n' "$key_payload" > minisign.key
          else
            decoded_payload=$(printf '%s' "$key_payload" | base64 -d 2>/dev/null || true)
            if printf '%s' "$decoded_payload" | grep -qi "minisign secret key"; then
              printf '%s\n' "$decoded_payload" > minisign.key
            else
              printf 'untrusted comment: minisign secret key\n%s\n' "$key_payload" > minisign.key
            fi
          fi
          chmod 600 minisign.key
          for file in artifacts/sliver-*; do
            [ -f "$file" ] || continue
            minisign -S -s minisign.key -m "$file" -x "$file.minisig" -W
          done
          rm -f minisign.key

      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${{ needs.tag-check.outputs.tag }}"
          if gh release view "$tag" >/dev/null 2>&1; then
            echo "Release $tag already exists."
            exit 0
          fi
          gh release create "$tag" --generate-notes

      - name: Upload Artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload "${{ needs.tag-check.outputs.tag }}" artifacts/* --clobber
